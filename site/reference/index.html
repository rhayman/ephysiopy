
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../how-to-guides/">
      
      
        <link rel="next" href="../explanation/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>Reference - ephysiopy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.fad675c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ephysiopy.common.binning" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ephysiopy" class="md-header__button md-logo" aria-label="ephysiopy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ephysiopy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ephysiopy" class="md-nav__button md-logo" aria-label="ephysiopy" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ephysiopy
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to MkDocs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../how-to-guides/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    How to guides
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Reference
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Reference
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ephysiopy.common.binning" class="md-nav__link">
    <span class="md-ellipsis">
      binning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap" class="md-nav__link">
    <span class="md-ellipsis">
      RateMap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RateMap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.nBins" class="md-nav__link">
    <span class="md-ellipsis">
      nBins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.pos_weights" class="md-nav__link">
    <span class="md-ellipsis">
      pos_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D" class="md-nav__link">
    <span class="md-ellipsis">
      autoCorr2D()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="autoCorr2D()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D" class="md-nav__link">
    <span class="md-ellipsis">
      crossCorr2D()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="crossCorr2D()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.doStackedCorrelations" class="md-nav__link">
    <span class="md-ellipsis">
      doStackedCorrelations()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="doStackedCorrelations()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.doStackedCorrelations--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap" class="md-nav__link">
    <span class="md-ellipsis">
      getAdaptiveMap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getAdaptiveMap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights" class="md-nav__link">
    <span class="md-ellipsis">
      getAllSpikeWeights()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getAllSpikeWeights()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap" class="md-nav__link">
    <span class="md-ellipsis">
      getMap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getMap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSAC" class="md-nav__link">
    <span class="md-ellipsis">
      getSAC()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSpatialSparsity" class="md-nav__link">
    <span class="md-ellipsis">
      getSpatialSparsity()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getSpatialSparsity()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSpatialSparsity--references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.get_egocentric_boundary_map" class="md-nav__link">
    <span class="md-ellipsis">
      get_egocentric_boundary_map()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC" class="md-nav__link">
    <span class="md-ellipsis">
      tWinSAC()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tWinSAC()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../explanation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Explanation
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ephysiopy.common.binning" class="md-nav__link">
    <span class="md-ellipsis">
      binning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap" class="md-nav__link">
    <span class="md-ellipsis">
      RateMap
    </span>
  </a>
  
    <nav class="md-nav" aria-label="RateMap">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.nBins" class="md-nav__link">
    <span class="md-ellipsis">
      nBins
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.pos_weights" class="md-nav__link">
    <span class="md-ellipsis">
      pos_weights
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D" class="md-nav__link">
    <span class="md-ellipsis">
      autoCorr2D()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="autoCorr2D()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.autoCorr2D--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D" class="md-nav__link">
    <span class="md-ellipsis">
      crossCorr2D()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="crossCorr2D()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.crossCorr2D--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.doStackedCorrelations" class="md-nav__link">
    <span class="md-ellipsis">
      doStackedCorrelations()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="doStackedCorrelations()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.doStackedCorrelations--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap" class="md-nav__link">
    <span class="md-ellipsis">
      getAdaptiveMap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getAdaptiveMap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--notes" class="md-nav__link">
    <span class="md-ellipsis">
      Notes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAdaptiveMap--references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights" class="md-nav__link">
    <span class="md-ellipsis">
      getAllSpikeWeights()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getAllSpikeWeights()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getAllSpikeWeights--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap" class="md-nav__link">
    <span class="md-ellipsis">
      getMap()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getMap()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getMap--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSAC" class="md-nav__link">
    <span class="md-ellipsis">
      getSAC()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSpatialSparsity" class="md-nav__link">
    <span class="md-ellipsis">
      getSpatialSparsity()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="getSpatialSparsity()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.getSpatialSparsity--references" class="md-nav__link">
    <span class="md-ellipsis">
      References
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.get_egocentric_boundary_map" class="md-nav__link">
    <span class="md-ellipsis">
      get_egocentric_boundary_map()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC" class="md-nav__link">
    <span class="md-ellipsis">
      tWinSAC()
    </span>
  </a>
  
    <nav class="md-nav" aria-label="tWinSAC()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ephysiopy.common.binning.RateMap.tWinSAC--returns" class="md-nav__link">
    <span class="md-ellipsis">
      Returns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Reference</h1>

<div class="doc doc-object doc-module">



<a id="ephysiopy.common.binning"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">








<div class="doc doc-object doc-class">




<h2 id="ephysiopy.common.binning.RateMap" class="doc doc-heading">
          <code>RateMap</code>


</h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code>object</code></p>

  
      <p>Bins up positional data (xy, head direction etc) and produces rate maps
of the relevant kind. This is a generic class meant to be independent of
any particular recording format</p>
<h4 id="ephysiopy.common.binning.RateMap--parameters">Parameters</h4>
<p>xy : array_like, optional
    The xy data, usually given as a 2 x n sample numpy array
hdir : array_like, optional
    The head direction data, usualy a 1 x n sample numpy array
speed : array_like, optional
    Similar to hdir
pos_weights : array_like, optional
    A 1D numpy array n samples long which is used to weight a particular
    position sample when binning data. For example, if there were 5
    positions recorded and a cell spiked once in position 2 and 5 times
    in position 3 and nothing anywhere else then pos_weights looks like:
    [0 0 1 5 0]
    In the case of binning up position this will be an array of mostly 1's
    unless there are some positions you want excluded for some reason
ppm : int, optional
    Pixels per metre. Specifies how many camera pixels per metre so this,
    in combination with cmsPerBin, will determine how many bins there are
    in the rate map
xyInCms : bool, optional, default False
    Whether the positional data is in cms
cmsPerBin : int, optional, default 3
    How many cms on a side each bin is in a rate map OR the number of
    degrees per bin in the case of directional binning
smooth_sz : int, optional, default = 5
    The width of the smoothing kernel for smoothing rate maps</p>
<h4 id="ephysiopy.common.binning.RateMap--notes">Notes</h4>
<p>There are several instance variables you can set, see below</p>

            <details class="quote">
              <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">RateMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bins up positional data (xy, head direction etc) and produces rate maps</span>
<span class="sd">    of the relevant kind. This is a generic class meant to be independent of</span>
<span class="sd">    any particular recording format</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xy : array_like, optional</span>
<span class="sd">        The xy data, usually given as a 2 x n sample numpy array</span>
<span class="sd">    hdir : array_like, optional</span>
<span class="sd">        The head direction data, usualy a 1 x n sample numpy array</span>
<span class="sd">    speed : array_like, optional</span>
<span class="sd">        Similar to hdir</span>
<span class="sd">    pos_weights : array_like, optional</span>
<span class="sd">        A 1D numpy array n samples long which is used to weight a particular</span>
<span class="sd">        position sample when binning data. For example, if there were 5</span>
<span class="sd">        positions recorded and a cell spiked once in position 2 and 5 times</span>
<span class="sd">        in position 3 and nothing anywhere else then pos_weights looks like:</span>
<span class="sd">        [0 0 1 5 0]</span>
<span class="sd">        In the case of binning up position this will be an array of mostly 1&#39;s</span>
<span class="sd">        unless there are some positions you want excluded for some reason</span>
<span class="sd">    ppm : int, optional</span>
<span class="sd">        Pixels per metre. Specifies how many camera pixels per metre so this,</span>
<span class="sd">        in combination with cmsPerBin, will determine how many bins there are</span>
<span class="sd">        in the rate map</span>
<span class="sd">    xyInCms : bool, optional, default False</span>
<span class="sd">        Whether the positional data is in cms</span>
<span class="sd">    cmsPerBin : int, optional, default 3</span>
<span class="sd">        How many cms on a side each bin is in a rate map OR the number of</span>
<span class="sd">        degrees per bin in the case of directional binning</span>
<span class="sd">    smooth_sz : int, optional, default = 5</span>
<span class="sd">        The width of the smoothing kernel for smoothing rate maps</span>

<span class="sd">    Notes</span>
<span class="sd">    ----</span>
<span class="sd">    There are several instance variables you can set, see below</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hdir</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">speed</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pos_weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pos_times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ppm</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">430</span><span class="p">,</span>
        <span class="n">xyInCms</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">smooth_sz</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">hdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_weights</span> <span class="o">=</span> <span class="n">pos_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_times</span> <span class="o">=</span> <span class="n">pos_times</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_time_splits</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spike_weights</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppm</span> <span class="o">=</span> <span class="n">ppm</span>  <span class="c1"># pixels per metre</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span> <span class="o">=</span> <span class="n">binsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inCms</span> <span class="o">=</span> <span class="n">xyInCms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nBins</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># has setter and getter - see below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_lims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_lims</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_sz</span> <span class="o">=</span> <span class="n">smooth_sz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smoothingType</span> <span class="o">=</span> <span class="s2">&quot;gaussian&quot;</span>  <span class="c1"># &#39;boxcar&#39; or &#39;gaussian&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whenToSmooth</span> <span class="o">=</span> <span class="s2">&quot;before&quot;</span>  <span class="c1"># or &#39;after&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var2Bin</span> <span class="o">=</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapType</span> <span class="o">=</span> <span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">inCms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Whether the units are in cms or not</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inCms</span>

    <span class="nd">@inCms</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">inCms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inCms</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ppm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get the current pixels per metre (ppm)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppm</span>

    <span class="nd">@ppm</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ppm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppm</span> <span class="o">=</span> <span class="n">value</span>
        <span class="c1"># self._binedges = self._calcBinEdges(self.binsize)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">var2Bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var2Bin</span>

    <span class="nd">@var2Bin</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">var2Bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_var2Bin</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mapType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapType</span>

    <span class="nd">@mapType</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">mapType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mapType</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nBins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The number of bins for each dim</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@nBins</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nBins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sets the number of bins</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">:</span>
            <span class="n">x_lims</span><span class="p">,</span> <span class="n">y_lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getXYLimits</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_x</span><span class="p">,</span> <span class="n">bs_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_y</span><span class="p">,</span> <span class="n">bs_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">_x</span><span class="p">,</span> <span class="n">bs_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                       <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">_y</span><span class="p">,</span> <span class="n">bs_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                       <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span> <span class="o">=</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_x</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">bs_x</span><span class="p">,</span> <span class="n">bs_y</span><span class="p">])</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span> <span class="n">binsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                                  <span class="mi">360</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span><span class="p">,</span>
                                                  <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">binsize</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="p">:</span>
            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span> <span class="n">binsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">maxspeed</span><span class="p">,</span>
                                                  <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">binsize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binedges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span>

    <span class="nd">@binedges</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">binedges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x_lims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x_lims</span>

    <span class="nd">@x_lims</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">x_lims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_x_lims</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y_lims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y_lims</span>

    <span class="nd">@y_lims</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">y_lims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_y_lims</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The &#39;weights&#39; used as an argument to np.histogram* for binning up</span>
<span class="sd">        position</span>
<span class="sd">        Mostly this is just an array of 1&#39;s equal to the length of the pos</span>
<span class="sd">        data, but usefully can be adjusted when masking data in the trial</span>
<span class="sd">        by</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_weights</span>

    <span class="nd">@pos_weights</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pos_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_weights</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_times</span>

    <span class="nd">@pos_times</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pos_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_times</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos_time_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_times</span>

    <span class="nd">@pos_time_splits</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pos_time_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pos_times</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spike_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spike_weights</span>

    <span class="nd">@spike_weights</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spike_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spike_weights</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The number of cms per bin of the binned up map</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span>

    <span class="nd">@binsize</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">binsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binsize</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smooth_sz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The size of the smoothing window applied to the binned data</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_sz</span>

    <span class="nd">@smooth_sz</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smooth_sz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_sz</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">smoothingType</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The type of smoothing to do - legal values are &#39;boxcar&#39; or &#39;gaussian&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smoothingType</span>

    <span class="nd">@smoothingType</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">smoothingType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smoothingType</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">_getXYLimits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets the min/max of the x/y data</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">x_lims</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;x_lims&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">y_lims</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;y_lims&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x_lims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">y_lims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_lims</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_lims</span> <span class="o">=</span> <span class="n">x_lims</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_lims</span> <span class="o">=</span> <span class="n">y_lims</span>
        <span class="k">return</span> <span class="n">x_lims</span><span class="p">,</span> <span class="n">y_lims</span>

    <span class="k">def</span> <span class="nf">_calcBinDims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_binDims</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_binDims</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calcBinEdges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binsize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aims to get the right number of bins for the variable to be</span>
<span class="sd">        binned</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        binsize : int, optional, default = 3</span>
<span class="sd">            The number of cms per bin for XY</span>
<span class="sd">            OR degrees for DIR</span>
<span class="sd">            OR cm/s for SPEED</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple: each member an array of bin edges</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span> <span class="o">+</span> <span class="n">binsize</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">maxspeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">)</span>
            <span class="c1"># assume min speed = 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxspeed</span><span class="p">,</span> <span class="n">binsize</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">:</span>
            <span class="n">x_lims</span><span class="p">,</span> <span class="n">y_lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getXYLimits</span><span class="p">()</span>
            <span class="n">nxbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">binsize</span><span class="p">))</span>
            <span class="n">nybins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">binsize</span><span class="p">))</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nxbins</span><span class="p">)</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nybins</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binedges</span> <span class="o">=</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_x</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY_TIME</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_time_splits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need pos times to bin up XY_TIME&quot;</span><span class="p">)</span>
            <span class="n">x_lims</span><span class="p">,</span> <span class="n">y_lims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getXYLimits</span><span class="p">()</span>
            <span class="n">nxbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">binsize</span><span class="p">))</span>
            <span class="n">nybins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">binsize</span><span class="p">))</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nxbins</span><span class="p">)</span>
            <span class="n">_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nybins</span><span class="p">)</span>
            <span class="n">be</span> <span class="o">=</span> <span class="p">[</span><span class="n">_y</span><span class="p">,</span> <span class="n">_x</span><span class="p">]</span>
            <span class="n">be</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_time_splits</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">binedges</span> <span class="o">=</span> <span class="n">be</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinDims</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">binedges</span>

    <span class="k">def</span> <span class="nf">getSpatialSparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">spkWeights</span><span class="p">,</span>
                           <span class="n">sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Gets the spatial sparsity measure - closer to 1 means</span>
<span class="sd">        sparser firing field.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Skaggs, W.E., McNaughton, B.L., Wilson, M.A. &amp; Barnes, C.A.</span>
<span class="sd">        Theta phase precession in hippocampal neuronal populations</span>
<span class="sd">        and the compression of temporal sequences.</span>
<span class="sd">        Hippocampus 6, 149172 (1996).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">=</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">()</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">,</span>
                               <span class="n">keep_these</span><span class="p">)</span>
        <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">npos</span> <span class="o">/</span> <span class="n">sample_rate</span>
        <span class="n">spk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                               <span class="n">spkWeights</span><span class="p">,</span>
                               <span class="n">keep_these</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_i</span><span class="o">*</span><span class="n">spk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_i</span><span class="o">*</span><span class="n">spk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">getMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span>
               <span class="n">varType</span><span class="o">=</span><span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span>
               <span class="n">mapType</span><span class="o">=</span><span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span>
               <span class="n">smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bins up the variable type varType and returns a tuple of</span>
<span class="sd">        (rmap, binnedPositionDir) or</span>
<span class="sd">        (rmap, binnedPostionX, binnedPositionY)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spkWeights : array_like</span>
<span class="sd">            Shape equal to number of positions samples captured and consists of</span>
<span class="sd">            position weights. For example, if there were 5 positions</span>
<span class="sd">            recorded and a cell spiked once in position 2 and 5 times in</span>
<span class="sd">            position 3 and nothing anywhere else then pos_weights looks</span>
<span class="sd">            like: [0 0 1 5 0]</span>
<span class="sd">        varType : Enum value - see Variable2Bin defined at top of this file</span>
<span class="sd">            The variable to bin up. Legal values are: XY, DIR and SPEED</span>
<span class="sd">        mapType : enum value - see MapType defined at top of this file</span>
<span class="sd">            If RATE then the binned up spikes are divided by varType.</span>
<span class="sd">            Otherwise return binned up position. Options are RATE or POS</span>
<span class="sd">        smoothing : bool, optional, default True</span>
<span class="sd">            Whether to smooth the data or not</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        binned_data, binned_pos : tuple</span>
<span class="sd">            This is either a 2-tuple or a 3-tuple depening on whether binned</span>
<span class="sd">            pos (mapType &#39;pos&#39;) or binned spikes (mapType &#39;rate&#39;) is asked</span>
<span class="sd">            for respectively</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
            <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
            <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY_TIME</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_times</span><span class="p">)))</span>
            <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized variable to bin.&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">=</span> <span class="n">varType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spike_weights</span> <span class="o">=</span> <span class="n">spkWeights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binsize</span><span class="p">)</span>

        <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span>
                                                     <span class="n">sample</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">,</span>
                                                     <span class="n">keep_these</span><span class="p">)</span>
        <span class="n">nanIdx</span> <span class="o">=</span> <span class="n">binned_pos</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">mapType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">MapType</span><span class="o">.</span><span class="n">POS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># return binned up position</span>
            <span class="k">if</span> <span class="n">smoothing</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                    <span class="n">binned_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span>
                        <span class="n">binned_pos</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">binned_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                                           <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span>

        <span class="n">binned_spk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span> <span class="n">keep_these</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">MapType</span><span class="o">.</span><span class="n">SPK</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">binned_spk</span>
        <span class="c1"># binned_spk is returned as a tuple of the binned data and the bin</span>
        <span class="c1"># edges</span>
        <span class="k">if</span> <span class="s2">&quot;after&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whenToSmooth</span><span class="p">:</span>
            <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
            <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">rmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">rmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rmap</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">rmap</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                                 <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># default case</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">smoothing</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span>
            <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">binned_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
                <span class="n">binned_spk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">binned_spk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
                <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">binned_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                                       <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">binned_spk_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">binned_spk_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">binned_spk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">binned_spk</span> <span class="o">=</span> <span class="n">binned_spk_tmp</span>
                <span class="n">binned_spk</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span>
                    <span class="n">binned_spk</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                    <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
                <span class="k">if</span> <span class="n">rmap</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">rmap</span><span class="p">[</span><span class="n">nanIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">rmap</span><span class="p">,</span> <span class="n">binned_pos_edges</span>

    <span class="k">def</span> <span class="nf">getSAC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the SAC - convenience function</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMap</span><span class="p">(</span><span class="n">spkWeights</span><span class="o">=</span><span class="n">spkWeights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">nodwell</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoCorr2D</span><span class="p">(</span><span class="n">rmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodwell</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_binData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">good_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bins data taking account of possible multi-dimensionality</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : array_like</span>
<span class="sd">            The variable to bin</span>
<span class="sd">        bin_edges : array_like</span>
<span class="sd">            The edges of the data - see numpys histogramdd for more</span>
<span class="sd">        weights : array_like</span>
<span class="sd">            The weights attributed to the samples in var</span>
<span class="sd">        good_indices : array_like</span>
<span class="sd">            Valid indices (i.e. not nan and not infinite)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndhist : 2-tuple</span>
<span class="sd">            Think this always returns a two-tuple of the binned variable and</span>
<span class="sd">            the bin edges - need to check to be sure...</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This breaks compatability with numpys histogramdd</span>
<span class="sd">        In the 2d histogram case below I swap the axes around so that x and y</span>
<span class="sd">        are binned in the &#39;normal&#39; format i.e. so x appears horizontally and y</span>
<span class="sd">        vertically.</span>
<span class="sd">        Multi-binning issue is dealt with awkwardly through checking</span>
<span class="sd">        the dimensionality of the weights array.</span>
<span class="sd">        &#39;normally&#39; this would be 1 dim but when multiple clusters are being</span>
<span class="sd">        binned it will be 2 dim.</span>
<span class="sd">        In that case np.apply_along_axis functionality is applied.</span>
<span class="sd">        The spike weights in that case might be created like so:</span>

<span class="sd">        &gt;&gt;&gt; spk_W = np.zeros(shape=[len(trial.nClusters), trial.npos])</span>
<span class="sd">        &gt;&gt;&gt; for i, cluster in enumerate(trial.clusters):</span>
<span class="sd">        &gt;&gt;&gt;		x1 = trial.getClusterIdx(cluster)</span>
<span class="sd">        &gt;&gt;&gt;		spk_W[i, :] = np.bincount(x1, minlength=trial.npos)</span>

<span class="sd">        This can then be fed into this fcn something like so:</span>

<span class="sd">        &gt;&gt;&gt; rng = np.array((np.ma.min(</span>
<span class="sd">            trial.POS.xy, 1).data, np.ma.max(rial.POS.xy, 1).data))</span>
<span class="sd">        &gt;&gt;&gt; h = _binData(</span>
<span class="sd">            var=trial.POS.xy, bin_edges=np.array([64, 64]),</span>
<span class="sd">            weights=spk_W, rng=rng)</span>

<span class="sd">        Returned will be a tuple containing the binned up data and</span>
<span class="sd">        the bin edges for x and y (obv this will be the same for all</span>
<span class="sd">        entries of h)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="c1"># if self.var2Bin != VariableToBin.XY and len(bin_edges) != 1:</span>
            <span class="c1">#     bin_edges = self._calcBinEdges(self.binsize)</span>
            <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">dims</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>  <span class="c1"># needed for list comp below</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">ndhist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span>
                <span class="n">sample</span><span class="o">=</span><span class="n">var</span><span class="p">[</span><span class="n">good_indices</span><span class="p">],</span>
                <span class="n">bins</span><span class="o">=</span><span class="n">bin_edges</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">good_indices</span><span class="p">]))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">weights</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ndhist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ndhist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">ndhist</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ndhist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_circPadSmooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smooths a vector by convolving with a gaussian</span>
<span class="sd">        Mirror reflects the start and end of the vector to</span>
<span class="sd">        deal with edge effects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var : array_like</span>
<span class="sd">            The vector to smooth</span>
<span class="sd">        n, ny : int</span>
<span class="sd">            Size of the smoothing (sigma in gaussian)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : array_like</span>
<span class="sd">            The smoothed vector with shape the same as var</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">tn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">tn</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">var</span><span class="p">[</span><span class="n">t2</span><span class="p">:</span><span class="n">tn</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">t2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ny</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ny</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ny</span><span class="p">:</span> <span class="n">ny</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">ny</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">improc</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
        <span class="n">improc</span> <span class="o">=</span> <span class="n">improc</span><span class="p">[</span><span class="n">tn</span> <span class="o">-</span> <span class="n">t2</span><span class="p">:</span> <span class="n">tn</span> <span class="o">-</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">tn</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">improc</span>

    <span class="k">def</span> <span class="nf">_circularStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a circular binary structure for use with morphological</span>
<span class="sd">        operations such as ndimage.binary_dilation etc</span>

<span class="sd">        This is only used in this implementation for adaptively binning</span>
<span class="sd">        ratemaps for use with information theoretic measures (Skaggs etc)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        radius : int</span>
<span class="sd">            the size of the circular structure</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : array_like</span>
<span class="sd">            Binary structure with shape [(radius*2) + 1,(radius*2) + 1]</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        RateMap.__adpativeMap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">disk</span>

        <span class="k">return</span> <span class="n">disk</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getAdaptiveMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_binned</span><span class="p">,</span> <span class="n">spk_binned</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Produces a ratemap that has been adaptively binned according to the</span>
<span class="sd">        algorithm described in Skaggs et al., 1996) [1]_.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pos_binned : array_like</span>
<span class="sd">            The binned positional data. For example that returned from getMap</span>
<span class="sd">            above with mapType as &#39;pos&#39;</span>
<span class="sd">        spk_binned : array_like</span>
<span class="sd">            The binned spikes</span>
<span class="sd">        alpha : int, optional, default = 200</span>
<span class="sd">            A scaling parameter determing the amount of occupancy to aim at</span>
<span class="sd">            in each bin</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Returns adaptively binned spike and pos maps. Use to generate Skaggs</span>
<span class="sd">        information measure</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Positions with high rates mean proportionately less error than those</span>
<span class="sd">        with low rates, so this tries to even the playing field. This type</span>
<span class="sd">        of binning should be used for calculations of spatial info</span>
<span class="sd">        as with the skaggs_info method in the fieldcalcs class (see below)</span>
<span class="sd">        alpha is a scaling parameter that might need tweaking for different</span>
<span class="sd">        data sets.</span>
<span class="sd">        From the paper:</span>
<span class="sd">            The data [are] first binned</span>
<span class="sd">            into a 64 X 64 grid of spatial locations, and then the firing rate</span>
<span class="sd">            at each point in this grid was calculated by expanding a circle</span>
<span class="sd">            around the point until the following criterion was met:</span>
<span class="sd">                Nspks &gt; alpha / (Nocc^2 * r^2)</span>
<span class="sd">            where Nspks is the number of spikes emitted in a circle of radius</span>
<span class="sd">            r (in bins), Nocc is the number of occupancy samples, alpha is the</span>
<span class="sd">            scaling parameter</span>
<span class="sd">            The firing rate in the given bin is then calculated as:</span>
<span class="sd">                sample_rate * (Nspks / Nocc)</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] W. E. Skaggs, B. L. McNaughton, K. M. Gothard &amp; E. J. Markus</span>
<span class="sd">            &quot;An Information-Theoretic Approach to Deciphering the Hippocampal</span>
<span class="sd">            Code&quot;</span>
<span class="sd">            Neural Information Processing Systems, 1993.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#  assign output arrays</span>
        <span class="n">smthdPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
        <span class="n">smthdSpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spk_binned</span><span class="p">)</span>
        <span class="n">smthdRate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">pos_binned</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">pos_binned</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">spk_binned</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
        <span class="n">visited</span><span class="p">[</span><span class="n">pos_binned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># array to check which bins have made it</span>
        <span class="n">binCheck</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">binCheck</span><span class="p">):</span>
            <span class="c1"># create the filter kernel</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circularStructure</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span> <span class="o">&gt;=</span> <span class="n">pos_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># filter the arrays using astropys convolution</span>
            <span class="n">filtPos</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">filtSpk</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">spk_binned</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">filtVisited</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">visited</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1"># get the bins which made it through this iteration</span>
            <span class="n">trueBins</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">filtSpk</span><span class="p">)</span> <span class="o">*</span> <span class="n">filtPos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">r</span>
            <span class="n">trueBins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">trueBins</span><span class="p">,</span> <span class="o">~</span><span class="n">binCheck</span><span class="p">)</span>
            <span class="c1"># insert values where true</span>
            <span class="n">smthdPos</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtPos</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">/</span> <span class="n">filtVisited</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span>
            <span class="n">smthdSpk</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtSpk</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">/</span> <span class="n">filtVisited</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span>
            <span class="n">binCheck</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">smthdRate</span> <span class="o">=</span> <span class="n">smthdSpk</span> <span class="o">/</span> <span class="n">smthdPos</span>
        <span class="n">smthdRate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">smthdSpk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">smthdPos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">smthdRate</span><span class="p">,</span> <span class="n">smthdSpk</span><span class="p">,</span> <span class="n">smthdPos</span>

    <span class="k">def</span> <span class="nf">autoCorr2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a spatial autocorrelation on the array A</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A : array_like</span>
<span class="sd">            Either 2 or 3D. In the former it is simply the binned up ratemap</span>
<span class="sd">            where the two dimensions correspond to x and y.</span>
<span class="sd">            If 3D then the first two dimensions are x</span>
<span class="sd">            and y and the third (last dimension) is &#39;stack&#39; of ratemaps</span>
<span class="sd">        nodwell : array_like</span>
<span class="sd">            A boolean array corresponding the bins in the ratemap that</span>
<span class="sd">            weren&#39;t visited. See Notes below.</span>
<span class="sd">        tol : float, optional</span>
<span class="sd">            Values below this are set to zero to deal with v small values</span>
<span class="sd">            thrown up by the fft. Default 1e-10</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sac : array_like</span>
<span class="sd">            The spatial autocorrelation in the relevant dimensionality</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The nodwell input can usually be generated by:</span>

<span class="sd">        &gt;&gt;&gt; nodwell = ~np.isfinite(A)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="n">nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
        <span class="n">x</span><span class="p">[</span><span class="n">nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># [Step 1] Obtain FFTs of x, the sum of squares and bins visited</span>
        <span class="n">Fx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">FsumOfSquares_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">Fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># [Step 2] Multiply the relevant transforms and invert to obtain the</span>
        <span class="c1"># equivalent convolutions</span>
        <span class="n">rawCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fx</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sums_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fx</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">sumOfSquares_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">FsumOfSquares_x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># [Step 3] Account for rounding errors.</span>
        <span class="n">rawCorr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rawCorr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sums_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sumOfSquares_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># [Step 4] Compute correlation matrix</span>
        <span class="n">mapStd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_x</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mapCovar</span> <span class="o">=</span> <span class="p">(</span><span class="n">rawCorr</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_x</span> <span class="o">*</span> \
            <span class="n">sums_x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
            <span class="n">mapCovar</span> <span class="o">/</span> <span class="n">mapStd</span> <span class="o">/</span> <span class="n">mapStd</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:])</span>

    <span class="k">def</span> <span class="nf">crossCorr2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A_nodwell</span><span class="p">,</span> <span class="n">B_nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a spatial crosscorrelation between the arrays A and B</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        A, B : array_like</span>
<span class="sd">            Either 2 or 3D. In the former it is simply the binned up ratemap</span>
<span class="sd">            where the two dimensions correspond to x and y.</span>
<span class="sd">            If 3D then the first two dimensions are x</span>
<span class="sd">            and y and the third (last dimension) is &#39;stack&#39; of ratemaps</span>
<span class="sd">        nodwell_A, nodwell_B : array_like</span>
<span class="sd">            A boolean array corresponding the bins in the ratemap that</span>
<span class="sd">            weren&#39;t visited. See Notes below.</span>
<span class="sd">        tol : float, optional</span>
<span class="sd">            Values below this are set to zero to deal with v small values</span>
<span class="sd">            thrown up by the fft. Default 1e-10</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        sac : array_like</span>
<span class="sd">            The spatial crosscorrelation in the relevant dimensionality</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The nodwell input can usually be generated by:</span>

<span class="sd">        &gt;&gt;&gt; nodwell = ~np.isfinite(A)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both arrays must have the same dimensionality&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">ma</span><span class="p">,</span> <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">mb</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="n">oa</span> <span class="o">=</span> <span class="n">ob</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">oa</span><span class="p">))</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">ob</span><span class="p">))</span>
        <span class="n">A_nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A_nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">oa</span><span class="p">))</span>
        <span class="n">B_nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B_nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">ob</span><span class="p">))</span>
        <span class="n">A</span><span class="p">[</span><span class="n">A_nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">B</span><span class="p">[</span><span class="n">B_nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># [Step 1] Obtain FFTs of x, the sum of squares and bins visited</span>
        <span class="n">Fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">FsumOfSquares_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">Fn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">A_nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">FsumOfSquares_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">Fn_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">B_nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># [Step 2] Multiply the relevant transforms and invert to obtain the</span>
        <span class="c1"># equivalent convolutions</span>
        <span class="n">rawCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fb</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">sums_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">Fa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">sums_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fb</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">sumOfSquares_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                        <span class="n">FsumOfSquares_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">sumOfSquares_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                        <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">FsumOfSquares_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="c1"># [Step 3] Account for rounding errors.</span>
        <span class="n">rawCorr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rawCorr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sums_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sums_b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sumOfSquares_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sumOfSquares_b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
        <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># [Step 4] Compute correlation matrix</span>
        <span class="n">mapStd_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_a</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mapStd_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_b</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mapCovar</span> <span class="o">=</span> <span class="p">(</span><span class="n">rawCorr</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_a</span> <span class="o">*</span> <span class="n">sums_b</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mapCovar</span> <span class="o">/</span> <span class="p">(</span><span class="n">mapStd_a</span> <span class="o">*</span> <span class="n">mapStd_b</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tWinSAC</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">xy</span><span class="p">,</span>
        <span class="n">spkIdx</span><span class="p">,</span>
        <span class="n">ppm</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
        <span class="n">winSize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">pos_sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">nbins</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span>
        <span class="n">boxcar</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">Pthresh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">downsampfreq</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temporal windowed spatial autocorrelation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        xy : array_like</span>
<span class="sd">            The position data</span>
<span class="sd">        spkIdx : array_like</span>
<span class="sd">            The indices in xy where the cell fired</span>
<span class="sd">        ppm : int, optional</span>
<span class="sd">            The camera pixels per metre. Default 365</span>
<span class="sd">        winSize : int, optional</span>
<span class="sd">            The window size for the temporal search</span>
<span class="sd">        pos_sample_rate : int, optional</span>
<span class="sd">            The rate at which position was sampled. Default 50</span>
<span class="sd">        nbins : int, optional</span>
<span class="sd">            The number of bins for creating the resulting ratemap. Default 71</span>
<span class="sd">        boxcar : int, optional</span>
<span class="sd">            The size of the smoothing kernel to smooth ratemaps. Default 5</span>
<span class="sd">        Pthresh : int, optional</span>
<span class="sd">            The cut=off for values in the ratemap; values &lt; Pthresh become</span>
<span class="sd">            nans.</span>
<span class="sd">            Default 100</span>
<span class="sd">        downsampfreq : int, optional</span>
<span class="sd">            How much to downsample. Default 50</span>
<span class="sd">        plot : bool, optional</span>
<span class="sd">            Whether to show a plot of the result. Default False</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        H : array_like</span>
<span class="sd">            The temporal windowed SAC</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># [Stage 0] Get some numbers</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">/</span> <span class="n">ppm</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">n_samps</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n_spks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">)</span>
        <span class="n">winSizeBins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">winSize</span> <span class="o">*</span> <span class="n">pos_sample_rate</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">])</span>
        <span class="c1"># factor by which positions are downsampled</span>
        <span class="n">downsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">pos_sample_rate</span> <span class="o">/</span> <span class="n">downsampfreq</span><span class="p">)</span>
        <span class="n">Pthresh</span> <span class="o">=</span> <span class="n">Pthresh</span> <span class="o">/</span> <span class="n">downsample</span>  <span class="c1"># take account of downsampling</span>

        <span class="c1"># [Stage 1] Calculate number of spikes in the window for each spikeInd</span>
        <span class="c1"># (ignoring spike itself)</span>
        <span class="c1"># 1a. Loop preparation</span>
        <span class="n">nSpikesInWin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_spks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># 1b. Keep looping until we have dealt with all spikes</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">))</span>
            <span class="n">nSpikesInWin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># ignore ith spike</span>

        <span class="c1"># [Stage 2] Prepare for main loop</span>
        <span class="c1"># 2a. Work out offset inidices to be used when storing spike data</span>
        <span class="n">off_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">nSpikesInWin</span><span class="p">])</span>
        <span class="n">off_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">off_spike</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># 2b. Work out number of downsampled pos bins in window and</span>
        <span class="c1"># offset indices for storing data</span>
        <span class="n">nPosInWindow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">winSizeBins</span><span class="p">,</span> <span class="n">n_samps</span> <span class="o">-</span> <span class="n">spkIdx</span><span class="p">)</span>
        <span class="n">nDownsampInWin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">nPosInWindow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">downsample</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">off_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">nDownsampInWin</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">off_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">off_dwell</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># 2c. Pre-allocate dwell and spike arrays, singles for speed</span>
        <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">off_dwell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">off_spike</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">filled_pvals</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">filled_svals</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_spks</span><span class="p">):</span>
            <span class="c1"># calculate dwell displacements</span>
            <span class="n">winInd_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">),</span>
                <span class="n">downsample</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">WL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winInd_dwell</span><span class="p">)</span>
            <span class="n">dwell</span><span class="p">[:,</span> <span class="n">filled_pvals</span><span class="p">:</span> <span class="n">filled_pvals</span> <span class="o">+</span> <span class="n">WL</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="n">winInd_dwell</span><span class="p">])</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="p">)</span>
            <span class="n">filled_pvals</span> <span class="o">=</span> <span class="n">filled_pvals</span> <span class="o">+</span> <span class="n">WL</span>
            <span class="c1"># calculate spike displacements</span>
            <span class="n">winInd_spks</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">i</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">n_spks</span><span class="p">]</span> <span class="o">&lt;</span>
                               <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">WL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winInd_spks</span><span class="p">)</span>
            <span class="n">spike</span><span class="p">[:,</span> <span class="n">filled_svals</span><span class="p">:</span> <span class="n">filled_svals</span> <span class="o">+</span> <span class="n">WL</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">winInd_spks</span><span class="p">]])</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="p">)</span>
            <span class="n">filled_svals</span> <span class="o">=</span> <span class="n">filled_svals</span> <span class="o">+</span> <span class="n">WL</span>

        <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dwell</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">spike</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spike</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dwell</span><span class="p">,</span> <span class="o">-</span><span class="n">dwell</span><span class="p">))</span>
        <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">spike</span><span class="p">,</span> <span class="o">-</span><span class="n">spike</span><span class="p">))</span>

        <span class="n">dwell_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dwell_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">binsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwell_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dwell_min</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">nbins</span>

        <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="p">(</span><span class="n">dwell</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dwell</span><span class="p">)</span> <span class="o">*</span> <span class="n">dwell_min</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">binsize</span>
        <span class="p">)</span>
        <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="p">(</span><span class="n">spike</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">spike</span><span class="p">)</span> <span class="o">*</span> <span class="n">dwell_min</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">binsize</span>
        <span class="p">)</span>

        <span class="n">binsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">binsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">dwell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dwell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                            <span class="nb">range</span><span class="o">=</span><span class="n">binedges</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binsize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Hs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">spike</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">spike</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                            <span class="nb">range</span><span class="o">=</span><span class="n">binedges</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binsize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># reverse y,x order</span>
        <span class="n">Hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">Hs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">fHp</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="n">boxcar</span><span class="p">)</span>
        <span class="n">fHs</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="n">boxcar</span><span class="p">)</span>

        <span class="n">H</span> <span class="o">=</span> <span class="n">fHs</span> <span class="o">/</span> <span class="n">fHp</span>
        <span class="n">H</span><span class="p">[</span><span class="n">Hp</span> <span class="o">&lt;</span> <span class="n">Pthresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">H</span>

    <span class="nd">@cache</span>
    <span class="k">def</span> <span class="nf">_create_boundary_distance_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="n">arena_boundary</span><span class="p">:</span> <span class="n">MultiLineString</span><span class="p">,</span>
                                         <span class="n">degs_per_bin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                         <span class="n">xy_binsize</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                         <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Now we generate lines radiating out from a point as a</span>
        <span class="c1"># multilinestring geometry collection - this looks</span>
        <span class="c1"># like a 360/degs_per_bin</span>
        <span class="c1"># star. We will move this to each valid location in the position map</span>
        <span class="c1"># and then calculate the distance to the nearest intersection with the</span>
        <span class="c1"># arena boundary.</span>
        <span class="c1"># get the arena boundaries to figure out the radius of the arena,</span>
        <span class="c1"># regardless of its actual shape</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="n">arena_boundary</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">startpoint</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">x1</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="n">radius</span><span class="p">))</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">Point</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="o">+</span><span class="n">radius</span><span class="p">])</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">MultiLineString</span><span class="p">(</span>
            <span class="p">[</span><span class="n">rotate</span><span class="p">(</span><span class="n">LineString</span><span class="p">([</span><span class="n">startpoint</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">]),</span> <span class="n">ang</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">startpoint</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">angles</span><span class="p">])</span>
        <span class="n">prepare</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="c1"># arena centre</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">radius</span>
        <span class="n">cy</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">radius</span>
        <span class="c1"># get the position map and the valid locations within it</span>
        <span class="n">pos_map</span><span class="p">,</span> <span class="p">(</span><span class="n">ybin_edges</span><span class="p">,</span> <span class="n">xbin_edges</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">),</span>
                                                        <span class="n">varType</span><span class="o">=</span><span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span>
                                                        <span class="n">mapType</span><span class="o">=</span><span class="n">MapType</span><span class="o">.</span><span class="n">POS</span><span class="p">,</span>
                                                        <span class="n">smoothing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">yvalid</span><span class="p">,</span> <span class="n">xvalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_map</span><span class="p">))</span>

        <span class="c1"># preallocate the array to hold distances</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xbin_edges</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ybin_edges</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Now iterate through valid locations in the pos map and calculate the</span>
        <span class="c1"># distances and the indices of the lines that intersect with the</span>
        <span class="c1"># arena boundary. The indices are equivalent to the angle of the</span>
        <span class="c1"># line in the lines geometry collection. This iteration is a bit slow</span>
        <span class="c1"># but it will only need to be done once per session as it&#39;s creating</span>
        <span class="c1"># a lookup table for the distances</span>
        <span class="k">for</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xvalid</span><span class="p">,</span> <span class="n">yvalid</span><span class="p">):</span>
            <span class="n">i_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">((</span><span class="n">xbin_edges</span><span class="p">[</span><span class="n">xi</span><span class="p">]</span><span class="o">+</span><span class="n">xy_binsize</span><span class="p">,</span>
                             <span class="n">ybin_edges</span><span class="p">[</span><span class="n">yi</span><span class="p">]</span><span class="o">+</span><span class="n">xy_binsize</span><span class="p">))</span>
            <span class="n">ipx</span><span class="p">,</span> <span class="n">ipy</span> <span class="o">=</span> <span class="n">i_point</span><span class="o">.</span><span class="n">xy</span>
            <span class="n">new_point</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="n">cx</span><span class="o">-</span><span class="n">ipx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cy</span><span class="o">-</span><span class="n">ipy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">t_arena</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">arena_boundary</span><span class="p">,</span> <span class="o">-</span><span class="n">new_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">new_point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="n">prepare</span><span class="p">(</span><span class="n">t_arena</span><span class="p">)</span>
            <span class="n">di</span> <span class="o">=</span> <span class="p">[(</span><span class="n">startpoint</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">t_arena</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span> <span class="n">idx</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="o">.</span><span class="n">geoms</span><span class="p">)</span> <span class="k">if</span>
                  <span class="n">t_arena</span><span class="o">.</span><span class="n">intersects</span><span class="p">(</span><span class="n">line</span><span class="p">)]</span>
            <span class="n">d</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">di</span><span class="p">)</span>
            <span class="n">distances</span><span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">return</span> <span class="n">distances</span>

    <span class="k">def</span> <span class="nf">get_egocentric_boundary_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="n">spk_weights</span><span class="p">,</span>
                                    <span class="n">degs_per_bin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                    <span class="n">xy_binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
                                    <span class="n">arena_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span>
                                    <span class="n">return_dists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_raw_spk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_raw_occ</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Supposed to help construct dwell time/spike counts</span>
<span class="sd">        maps wrt boundaries at given egocentric directions</span>
<span class="sd">        and distances</span>
<span class="sd">        NB: for the directional input</span>
<span class="sd">        the 0 degree reference is horiztonal pointing</span>
<span class="sd">        East and moves counter-clockwise</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No direction data available&quot;</span>
        <span class="c1"># initially do some binning to get valid locations</span>
        <span class="c1"># (some might be nans due to</span>
        <span class="c1"># arena shape and/or poor sampling) and then digitize</span>
        <span class="c1"># the x and y positions</span>
        <span class="c1"># and the angular positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">xy_binsize</span>  <span class="c1"># this will trigger a</span>
        <span class="c1"># re-calculation of the bin edges</span>

        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="p">)</span>

        <span class="c1"># Use the shaeply package to specify some geometry for the arena</span>
        <span class="c1"># boundary and the lines radiating out</span>
        <span class="c1"># from the current location of the animal. The geometry for the </span>
        <span class="c1"># arena should be user specified but for now I&#39;ll just use a circle</span>
        <span class="k">if</span> <span class="n">arena_type</span> <span class="o">==</span> <span class="s2">&quot;circle&quot;</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">circle_centre</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">radius</span><span class="p">)</span>
            <span class="n">arena_boundary</span> <span class="o">=</span> <span class="n">circle_centre</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">boundary</span>
        <span class="c1"># now we have a circle with its centre at the centre of the arena</span>
        <span class="c1"># i.e. the circle defines the arena edges. Calling .boundary on the</span>
        <span class="c1"># circle geometry actually gives us a 65-gon polygon</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_boundary_distance_lookup</span><span class="p">(</span>
            <span class="n">arena_boundary</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="p">,</span> <span class="n">xy_binsize</span><span class="p">)</span>
        <span class="c1"># iterate through the digitized locations (x/y and angular), using the</span>
        <span class="c1"># lookup table to get the distances to the arena boundary and then</span>
        <span class="c1"># increment the appropriate bin in the egocentric boundary map</span>
        <span class="n">good_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xy_by_heading</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">good_idx</span><span class="p">]],</span>
                                          <span class="n">bins</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                          <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">[</span><span class="n">good_idx</span><span class="p">])</span>
        <span class="n">spk_xy_by_hd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">good_idx</span><span class="p">]],</span>
                                         <span class="n">bins</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                         <span class="n">weights</span><span class="o">=</span><span class="n">spk_weights</span><span class="p">[</span><span class="n">good_idx</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">xy_by_heading</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">distances</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">distlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">anglist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spkdists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spkangs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_bin</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">i_dist</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i_bin</span><span class="p">]</span>
            <span class="n">valid_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">i_dist</span><span class="p">)</span>
            <span class="n">nonzero_bincounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">xy_by_heading</span><span class="p">[</span><span class="n">i_bin</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nonzero_spkbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">spk_xy_by_hd</span><span class="p">[</span><span class="n">i_bin</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i_angle</span> <span class="ow">in</span> <span class="n">nonzero_bincounts</span><span class="p">:</span>
                <span class="n">ego_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">i_angle</span><span class="p">)[</span><span class="n">valid_dist</span><span class="p">]</span>
                <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">xy_by_heading</span><span class="p">[</span><span class="n">i_bin</span><span class="p">][</span><span class="n">i_angle</span><span class="p">]</span>
                <span class="n">ego_angles_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ego_angles</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
                <span class="n">dist_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i_dist</span><span class="p">[</span><span class="n">valid_dist</span><span class="p">],</span> <span class="n">n_repeats</span><span class="p">)</span>
                <span class="n">distlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_repeats</span><span class="p">)</span>
                <span class="n">anglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ego_angles_repeats</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i_angle</span> <span class="ow">in</span> <span class="n">nonzero_spkbins</span><span class="p">:</span>
                    <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">spk_xy_by_hd</span><span class="p">[</span><span class="n">i_bin</span><span class="p">][</span><span class="n">i_angle</span><span class="p">]</span>
                    <span class="n">ego_angles_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ego_angles</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
                    <span class="n">dist_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i_dist</span><span class="p">[</span><span class="n">valid_dist</span><span class="p">],</span> <span class="n">n_repeats</span><span class="p">)</span>
                    <span class="n">spkdists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_repeats</span><span class="p">)</span>
                    <span class="n">spkangs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ego_angles_repeats</span><span class="p">)</span>
        <span class="n">flat_angs</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">anglist</span><span class="p">)</span>
        <span class="n">flat_dists</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">distlist</span><span class="p">)</span>
        <span class="n">flat_spk_dists</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">spkdists</span><span class="p">)</span>
        <span class="n">flat_spk_angs</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">spkangs</span><span class="p">)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="o">/</span><span class="n">xy_binsize</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)]</span>
        <span class="n">ego_boundary_occ</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flat_dists</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">flat_angs</span><span class="p">,</span>
                                                <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">ego_boundary_spk</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flat_spk_dists</span><span class="p">,</span>
                                                <span class="n">y</span><span class="o">=</span><span class="n">flat_spk_angs</span><span class="p">,</span>
                                                <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">sm_occ</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">ego_boundary_occ</span><span class="p">,</span>
                                      <span class="n">kernel</span><span class="p">,</span>
                                      <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
        <span class="n">sm_spk</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">ego_boundary_spk</span><span class="p">,</span>
                                      <span class="n">kernel</span><span class="p">,</span>
                                      <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
        <span class="n">ego_boundary_map</span> <span class="o">=</span> <span class="n">sm_spk</span> <span class="o">/</span> <span class="n">sm_occ</span>
        <span class="n">EgoMap</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;EgoMap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rmap&#39;</span><span class="p">,</span> <span class="s1">&#39;occ&#39;</span><span class="p">,</span> <span class="s1">&#39;spk&#39;</span><span class="p">,</span> <span class="s1">&#39;dists&#39;</span><span class="p">],</span>
                            <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">EgoMap</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rmap</span><span class="o">=</span><span class="n">ego_boundary_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_dists</span><span class="p">:</span>
            <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">dists</span><span class="o">=</span><span class="n">distances</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_raw_occ</span><span class="p">:</span>
            <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">occ</span><span class="o">=</span><span class="n">ego_boundary_occ</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_raw_spk</span><span class="p">:</span>
            <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">spk</span><span class="o">=</span><span class="n">ego_boundary_spk</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">em</span>

    <span class="k">def</span> <span class="nf">getAllSpikeWeights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">spike_times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">spike_clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">pos_times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spike_times: np.ndarray</span>
<span class="sd">            spike times in seconds</span>
<span class="sd">        spike_clusters: np.ndarray</span>
<span class="sd">            cluster identity vector</span>
<span class="sd">        pos_times: np.ndarray</span>
<span class="sd">            the times at which position was captured in seconds</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            the bincounts with respect to position for</span>
<span class="sd">            each cluster. Shape of returned array will</span>
<span class="sd">            be nClusters x npos</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spike_clusters</span><span class="p">)</span>
        <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pos_times</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">spike_clusters</span> <span class="o">==</span> <span class="n">c</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">npos</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_splitStackedCorrelations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binned_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Takes in the result of doStackedCorrelations() and splits into</span>
<span class="sd">        two arrays and returns these as a 2-tuple</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">binned_data</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>

    <span class="k">def</span> <span class="nf">doStackedCorrelations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">spkW</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                              <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                              <span class="n">splits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                              <span class="n">var2bin</span><span class="p">:</span> <span class="n">Enum</span> <span class="o">=</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span>
                              <span class="n">maptype</span><span class="p">:</span> <span class="n">Enum</span> <span class="o">=</span> <span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of binned data where each item in the list</span>
<span class="sd">        is the result of running np.histogramdd on a spatial</span>
<span class="sd">        variable (xy, dir etc) and a temporal one at the same</span>
<span class="sd">        time. The idea is to split the spatial variable into two</span>
<span class="sd">        temporal halves based on the bin edges in &#39;splits&#39; and</span>
<span class="sd">        then to run correlations between the two halves and</span>
<span class="sd">        furthermore to do this for all of the clusters that have</span>
<span class="sd">        spike weights in &#39;spkW&#39;. &#39;spkW&#39; should be the result of</span>
<span class="sd">        using getAllSpikeWeights().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        spkW - np.ndarray</span>
<span class="sd">            the result of calling getAllSpikeWeights()</span>
<span class="sd">        times - np.ndarray</span>
<span class="sd">            position times in seconds</span>
<span class="sd">        splits - np.ndarray</span>
<span class="sd">            where to split the data in seconds. Will</span>
<span class="sd">            typically take the form (0, 100, 200) for</span>
<span class="sd">            example which will give a split between 0-100</span>
<span class="sd">            and 100-200 seconds</span>
<span class="sd">        var2bin - Enum</span>
<span class="sd">            the spatial variable to bin up</span>
<span class="sd">        maptype - Enum</span>
<span class="sd">            the type of map to produce</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="k">elif</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="k">elif</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized variable to bin.&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_time_splits</span> <span class="o">=</span> <span class="n">splits</span>






        <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
        <span class="c1"># bin pos</span>
        <span class="n">bp</span><span class="p">,</span> <span class="n">bpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)</span>
        <span class="n">map1_pos</span><span class="p">,</span> <span class="n">map2_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">bp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">bp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="c1"># smooth position</span>
        <span class="n">map1_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">map1_pos</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
        <span class="n">map2_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">map2_pos</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
        <span class="c1"># bin spk - ie the histogram is weighted by spike count</span>
        <span class="c1"># in bin i</span>
        <span class="n">spk</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spkW</span><span class="p">]</span>
        <span class="n">map1_spk</span><span class="p">,</span> <span class="n">map2_spk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitStackedCorrelations</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span>
        <span class="n">map1_sm_spk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">blurImage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">map1_spk</span><span class="p">])</span>
        <span class="n">map2_sm_spk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">blurImage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">map2_spk</span><span class="p">])</span>
        <span class="n">map1_rmaps</span> <span class="o">=</span> <span class="n">map1_sm_spk</span> <span class="o">/</span> <span class="n">map1_pos</span>
        <span class="n">map2_rmaps</span> <span class="o">=</span> <span class="n">map2_sm_spk</span> <span class="o">/</span> <span class="n">map2_pos</span>
        <span class="k">return</span> <span class="n">map1_rmaps</span><span class="p">,</span> <span class="n">map2_rmaps</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h3 id="ephysiopy.common.binning.RateMap.nBins" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">nBins</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>The number of bins for each dim</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h3 id="ephysiopy.common.binning.RateMap.pos_weights" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pos_weights</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

</h3>


  <div class="doc doc-contents ">
  
      <p>The 'weights' used as an argument to np.histogram* for binning up
position
Mostly this is just an array of 1's equal to the length of the pos
data, but usefully can be adjusted when masking data in the trial
by</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.autoCorr2D" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">autoCorr2D</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Performs a spatial autocorrelation on the array A</p>
<h5 id="ephysiopy.common.binning.RateMap.autoCorr2D--parameters">Parameters</h5>
<p>A : array_like
    Either 2 or 3D. In the former it is simply the binned up ratemap
    where the two dimensions correspond to x and y.
    If 3D then the first two dimensions are x
    and y and the third (last dimension) is 'stack' of ratemaps
nodwell : array_like
    A boolean array corresponding the bins in the ratemap that
    weren't visited. See Notes below.
tol : float, optional
    Values below this are set to zero to deal with v small values
    thrown up by the fft. Default 1e-10</p>
<h5 id="ephysiopy.common.binning.RateMap.autoCorr2D--returns">Returns</h5>
<p>sac : array_like
    The spatial autocorrelation in the relevant dimensionality</p>
<h5 id="ephysiopy.common.binning.RateMap.autoCorr2D--notes">Notes</h5>
<p>The nodwell input can usually be generated by:</p>
<blockquote>
<blockquote>
<blockquote>
<p>nodwell = ~np.isfinite(A)</p>
</blockquote>
</blockquote>
</blockquote>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">autoCorr2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a spatial autocorrelation on the array A</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A : array_like</span>
<span class="sd">        Either 2 or 3D. In the former it is simply the binned up ratemap</span>
<span class="sd">        where the two dimensions correspond to x and y.</span>
<span class="sd">        If 3D then the first two dimensions are x</span>
<span class="sd">        and y and the third (last dimension) is &#39;stack&#39; of ratemaps</span>
<span class="sd">    nodwell : array_like</span>
<span class="sd">        A boolean array corresponding the bins in the ratemap that</span>
<span class="sd">        weren&#39;t visited. See Notes below.</span>
<span class="sd">    tol : float, optional</span>
<span class="sd">        Values below this are set to zero to deal with v small values</span>
<span class="sd">        thrown up by the fft. Default 1e-10</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sac : array_like</span>
<span class="sd">        The spatial autocorrelation in the relevant dimensionality</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The nodwell input can usually be generated by:</span>

<span class="sd">    &gt;&gt;&gt; nodwell = ~np.isfinite(A)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
    <span class="n">nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="p">))</span>
    <span class="n">x</span><span class="p">[</span><span class="n">nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># [Step 1] Obtain FFTs of x, the sum of squares and bins visited</span>
    <span class="n">Fx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">FsumOfSquares_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">Fn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># [Step 2] Multiply the relevant transforms and invert to obtain the</span>
    <span class="c1"># equivalent convolutions</span>
    <span class="n">rawCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fx</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fx</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sums_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fx</span><span class="p">)</span> <span class="o">*</span> <span class="n">Fn</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sumOfSquares_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">FsumOfSquares_x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fn</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span>
        <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># [Step 3] Account for rounding errors.</span>
    <span class="n">rawCorr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rawCorr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sums_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sumOfSquares_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># [Step 4] Compute correlation matrix</span>
    <span class="n">mapStd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_x</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mapCovar</span> <span class="o">=</span> <span class="p">(</span><span class="n">rawCorr</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_x</span> <span class="o">*</span> \
        <span class="n">sums_x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span>
        <span class="n">mapCovar</span> <span class="o">/</span> <span class="n">mapStd</span> <span class="o">/</span> <span class="n">mapStd</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:][:,</span> <span class="p">:,</span> <span class="p">:])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.crossCorr2D" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">crossCorr2D</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A_nodwell</span><span class="p">,</span> <span class="n">B_nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Performs a spatial crosscorrelation between the arrays A and B</p>
<h5 id="ephysiopy.common.binning.RateMap.crossCorr2D--parameters">Parameters</h5>
<p>A, B : array_like
    Either 2 or 3D. In the former it is simply the binned up ratemap
    where the two dimensions correspond to x and y.
    If 3D then the first two dimensions are x
    and y and the third (last dimension) is 'stack' of ratemaps
nodwell_A, nodwell_B : array_like
    A boolean array corresponding the bins in the ratemap that
    weren't visited. See Notes below.
tol : float, optional
    Values below this are set to zero to deal with v small values
    thrown up by the fft. Default 1e-10</p>
<h5 id="ephysiopy.common.binning.RateMap.crossCorr2D--returns">Returns</h5>

<details class="sac-" open>
  <summary>array_like</summary>
  <p>The spatial crosscorrelation in the relevant dimensionality</p>
</details>      <h5 id="ephysiopy.common.binning.RateMap.crossCorr2D--notes">Notes</h5>
<p>The nodwell input can usually be generated by:</p>
<blockquote>
<blockquote>
<blockquote>
<p>nodwell = ~np.isfinite(A)</p>
</blockquote>
</blockquote>
</blockquote>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">crossCorr2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">A_nodwell</span><span class="p">,</span> <span class="n">B_nodwell</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a spatial crosscorrelation between the arrays A and B</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    A, B : array_like</span>
<span class="sd">        Either 2 or 3D. In the former it is simply the binned up ratemap</span>
<span class="sd">        where the two dimensions correspond to x and y.</span>
<span class="sd">        If 3D then the first two dimensions are x</span>
<span class="sd">        and y and the third (last dimension) is &#39;stack&#39; of ratemaps</span>
<span class="sd">    nodwell_A, nodwell_B : array_like</span>
<span class="sd">        A boolean array corresponding the bins in the ratemap that</span>
<span class="sd">        weren&#39;t visited. See Notes below.</span>
<span class="sd">    tol : float, optional</span>
<span class="sd">        Values below this are set to zero to deal with v small values</span>
<span class="sd">        thrown up by the fft. Default 1e-10</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    sac : array_like</span>
<span class="sd">        The spatial crosscorrelation in the relevant dimensionality</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The nodwell input can usually be generated by:</span>

<span class="sd">    &gt;&gt;&gt; nodwell = ~np.isfinite(A)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Both arrays must have the same dimensionality&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">ma</span><span class="p">,</span> <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">mb</span><span class="p">,</span> <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">oa</span> <span class="o">=</span> <span class="n">ob</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">oa</span><span class="p">))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">ob</span><span class="p">))</span>
    <span class="n">A_nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">A_nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">na</span><span class="p">,</span> <span class="n">oa</span><span class="p">))</span>
    <span class="n">B_nodwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B_nodwell</span><span class="p">,</span> <span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">ob</span><span class="p">))</span>
    <span class="n">A</span><span class="p">[</span><span class="n">A_nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">B</span><span class="p">[</span><span class="n">B_nodwell</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># [Step 1] Obtain FFTs of x, the sum of squares and bins visited</span>
    <span class="n">Fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">FsumOfSquares_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">Fn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">A_nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">mb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">Fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">FsumOfSquares_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">Fn_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">B_nodwell</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="mi">2</span> <span class="o">*</span> <span class="n">na</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># [Step 2] Multiply the relevant transforms and invert to obtain the</span>
    <span class="c1"># equivalent convolutions</span>
    <span class="n">rawCorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">Fa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fb</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">sums_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">Fa</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">sums_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fb</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="n">sumOfSquares_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                    <span class="n">FsumOfSquares_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">sumOfSquares_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
                    <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">FsumOfSquares_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span>
            <span class="n">Fn_a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">Fn_b</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="c1"># [Step 3] Account for rounding errors.</span>
    <span class="n">rawCorr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">rawCorr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sums_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sums_b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sums_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sumOfSquares_a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sumOfSquares_b</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sumOfSquares_b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">N</span><span class="p">[</span><span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># [Step 4] Compute correlation matrix</span>
    <span class="n">mapStd_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_a</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mapStd_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sumOfSquares_b</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mapCovar</span> <span class="o">=</span> <span class="p">(</span><span class="n">rawCorr</span> <span class="o">*</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="n">sums_a</span> <span class="o">*</span> <span class="n">sums_b</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">mapCovar</span> <span class="o">/</span> <span class="p">(</span><span class="n">mapStd_a</span> <span class="o">*</span> <span class="n">mapStd_b</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.doStackedCorrelations" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">doStackedCorrelations</span><span class="p">(</span><span class="n">spkW</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">splits</span><span class="p">,</span> <span class="n">var2bin</span><span class="o">=</span><span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span> <span class="n">maptype</span><span class="o">=</span><span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns a list of binned data where each item in the list
is the result of running np.histogramdd on a spatial
variable (xy, dir etc) and a temporal one at the same
time. The idea is to split the spatial variable into two
temporal halves based on the bin edges in 'splits' and
then to run correlations between the two halves and
furthermore to do this for all of the clusters that have
spike weights in 'spkW'. 'spkW' should be the result of
using getAllSpikeWeights().</p>
<h5 id="ephysiopy.common.binning.RateMap.doStackedCorrelations--parameters">Parameters</h5>
<p>spkW - np.ndarray
    the result of calling getAllSpikeWeights()
times - np.ndarray
    position times in seconds
splits - np.ndarray
    where to split the data in seconds. Will
    typically take the form (0, 100, 200) for
    example which will give a split between 0-100
    and 100-200 seconds
var2bin - Enum
    the spatial variable to bin up
maptype - Enum
    the type of map to produce</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">doStackedCorrelations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">spkW</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">splits</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">var2bin</span><span class="p">:</span> <span class="n">Enum</span> <span class="o">=</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span>
                          <span class="n">maptype</span><span class="p">:</span> <span class="n">Enum</span> <span class="o">=</span> <span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span>
                          <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a list of binned data where each item in the list</span>
<span class="sd">    is the result of running np.histogramdd on a spatial</span>
<span class="sd">    variable (xy, dir etc) and a temporal one at the same</span>
<span class="sd">    time. The idea is to split the spatial variable into two</span>
<span class="sd">    temporal halves based on the bin edges in &#39;splits&#39; and</span>
<span class="sd">    then to run correlations between the two halves and</span>
<span class="sd">    furthermore to do this for all of the clusters that have</span>
<span class="sd">    spike weights in &#39;spkW&#39;. &#39;spkW&#39; should be the result of</span>
<span class="sd">    using getAllSpikeWeights().</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spkW - np.ndarray</span>
<span class="sd">        the result of calling getAllSpikeWeights()</span>
<span class="sd">    times - np.ndarray</span>
<span class="sd">        position times in seconds</span>
<span class="sd">    splits - np.ndarray</span>
<span class="sd">        where to split the data in seconds. Will</span>
<span class="sd">        typically take the form (0, 100, 200) for</span>
<span class="sd">        example which will give a split between 0-100</span>
<span class="sd">        and 100-200 seconds</span>
<span class="sd">    var2bin - Enum</span>
<span class="sd">        the spatial variable to bin up</span>
<span class="sd">    maptype - Enum</span>
<span class="sd">        the type of map to produce</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
    <span class="k">elif</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
    <span class="k">elif</span> <span class="n">var2bin</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized variable to bin.&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pos_time_splits</span> <span class="o">=</span> <span class="n">splits</span>






    <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">times</span><span class="p">)))</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span>
    <span class="c1"># bin pos</span>
    <span class="n">bp</span><span class="p">,</span> <span class="n">bpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">)</span>
    <span class="n">map1_pos</span><span class="p">,</span> <span class="n">map2_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">bp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">bp</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># smooth position</span>
    <span class="n">map1_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">map1_pos</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
    <span class="n">map2_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">map2_pos</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
    <span class="c1"># bin spk - ie the histogram is weighted by spike count</span>
    <span class="c1"># in bin i</span>
    <span class="n">spk</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spkW</span><span class="p">]</span>
    <span class="n">map1_spk</span><span class="p">,</span> <span class="n">map2_spk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitStackedCorrelations</span><span class="p">(</span><span class="n">spk</span><span class="p">)</span>
    <span class="n">map1_sm_spk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">blurImage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">map1_spk</span><span class="p">])</span>
    <span class="n">map2_sm_spk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">blurImage</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">map2_spk</span><span class="p">])</span>
    <span class="n">map1_rmaps</span> <span class="o">=</span> <span class="n">map1_sm_spk</span> <span class="o">/</span> <span class="n">map1_pos</span>
    <span class="n">map2_rmaps</span> <span class="o">=</span> <span class="n">map2_sm_spk</span> <span class="o">/</span> <span class="n">map2_pos</span>
    <span class="k">return</span> <span class="n">map1_rmaps</span><span class="p">,</span> <span class="n">map2_rmaps</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.getAdaptiveMap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">getAdaptiveMap</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">,</span> <span class="n">spk_binned</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Produces a ratemap that has been adaptively binned according to the
algorithm described in Skaggs et al., 1996) [1]_.</p>
<h5 id="ephysiopy.common.binning.RateMap.getAdaptiveMap--parameters">Parameters</h5>
<p>pos_binned : array_like
    The binned positional data. For example that returned from getMap
    above with mapType as 'pos'
spk_binned : array_like
    The binned spikes
alpha : int, optional, default = 200
    A scaling parameter determing the amount of occupancy to aim at
    in each bin</p>
<h5 id="ephysiopy.common.binning.RateMap.getAdaptiveMap--returns">Returns</h5>
<p>Returns adaptively binned spike and pos maps. Use to generate Skaggs
information measure</p>
<h5 id="ephysiopy.common.binning.RateMap.getAdaptiveMap--notes">Notes</h5>
<p>Positions with high rates mean proportionately less error than those
with low rates, so this tries to even the playing field. This type
of binning should be used for calculations of spatial info
as with the skaggs_info method in the fieldcalcs class (see below)
alpha is a scaling parameter that might need tweaking for different
data sets.
From the paper:
    The data [are] first binned
    into a 64 X 64 grid of spatial locations, and then the firing rate
    at each point in this grid was calculated by expanding a circle
    around the point until the following criterion was met:
        Nspks &gt; alpha / (Nocc^2 * r^2)
    where Nspks is the number of spikes emitted in a circle of radius
    r (in bins), Nocc is the number of occupancy samples, alpha is the
    scaling parameter
    The firing rate in the given bin is then calculated as:
        sample_rate * (Nspks / Nocc)</p>
<h5 id="ephysiopy.common.binning.RateMap.getAdaptiveMap--references">References</h5>
<p>.. [1] W. E. Skaggs, B. L. McNaughton, K. M. Gothard &amp; E. J. Markus
    "An Information-Theoretic Approach to Deciphering the Hippocampal
    Code"
    Neural Information Processing Systems, 1993.</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getAdaptiveMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos_binned</span><span class="p">,</span> <span class="n">spk_binned</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Produces a ratemap that has been adaptively binned according to the</span>
<span class="sd">    algorithm described in Skaggs et al., 1996) [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pos_binned : array_like</span>
<span class="sd">        The binned positional data. For example that returned from getMap</span>
<span class="sd">        above with mapType as &#39;pos&#39;</span>
<span class="sd">    spk_binned : array_like</span>
<span class="sd">        The binned spikes</span>
<span class="sd">    alpha : int, optional, default = 200</span>
<span class="sd">        A scaling parameter determing the amount of occupancy to aim at</span>
<span class="sd">        in each bin</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Returns adaptively binned spike and pos maps. Use to generate Skaggs</span>
<span class="sd">    information measure</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Positions with high rates mean proportionately less error than those</span>
<span class="sd">    with low rates, so this tries to even the playing field. This type</span>
<span class="sd">    of binning should be used for calculations of spatial info</span>
<span class="sd">    as with the skaggs_info method in the fieldcalcs class (see below)</span>
<span class="sd">    alpha is a scaling parameter that might need tweaking for different</span>
<span class="sd">    data sets.</span>
<span class="sd">    From the paper:</span>
<span class="sd">        The data [are] first binned</span>
<span class="sd">        into a 64 X 64 grid of spatial locations, and then the firing rate</span>
<span class="sd">        at each point in this grid was calculated by expanding a circle</span>
<span class="sd">        around the point until the following criterion was met:</span>
<span class="sd">            Nspks &gt; alpha / (Nocc^2 * r^2)</span>
<span class="sd">        where Nspks is the number of spikes emitted in a circle of radius</span>
<span class="sd">        r (in bins), Nocc is the number of occupancy samples, alpha is the</span>
<span class="sd">        scaling parameter</span>
<span class="sd">        The firing rate in the given bin is then calculated as:</span>
<span class="sd">            sample_rate * (Nspks / Nocc)</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] W. E. Skaggs, B. L. McNaughton, K. M. Gothard &amp; E. J. Markus</span>
<span class="sd">        &quot;An Information-Theoretic Approach to Deciphering the Hippocampal</span>
<span class="sd">        Code&quot;</span>
<span class="sd">        Neural Information Processing Systems, 1993.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  assign output arrays</span>
    <span class="n">smthdPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
    <span class="n">smthdSpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">spk_binned</span><span class="p">)</span>
    <span class="n">smthdRate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">pos_binned</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">pos_binned</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">spk_binned</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
    <span class="n">visited</span><span class="p">[</span><span class="n">pos_binned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># array to check which bins have made it</span>
    <span class="n">binCheck</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="o">~</span><span class="n">binCheck</span><span class="p">):</span>
        <span class="c1"># create the filter kernel</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circularStructure</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">h</span><span class="p">[</span><span class="n">h</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">shape</span> <span class="o">&gt;=</span> <span class="n">pos_binned</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># filter the arrays using astropys convolution</span>
        <span class="n">filtPos</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">pos_binned</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">filtSpk</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">spk_binned</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">filtVisited</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">visited</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># get the bins which made it through this iteration</span>
        <span class="n">trueBins</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">filtSpk</span><span class="p">)</span> <span class="o">*</span> <span class="n">filtPos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">r</span>
        <span class="n">trueBins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">trueBins</span><span class="p">,</span> <span class="o">~</span><span class="n">binCheck</span><span class="p">)</span>
        <span class="c1"># insert values where true</span>
        <span class="n">smthdPos</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtPos</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">/</span> <span class="n">filtVisited</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span>
        <span class="n">smthdSpk</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtSpk</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">/</span> <span class="n">filtVisited</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span>
        <span class="n">binCheck</span><span class="p">[</span><span class="n">trueBins</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">smthdRate</span> <span class="o">=</span> <span class="n">smthdSpk</span> <span class="o">/</span> <span class="n">smthdPos</span>
    <span class="n">smthdRate</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">smthdSpk</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">smthdPos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">smthdRate</span><span class="p">,</span> <span class="n">smthdSpk</span><span class="p">,</span> <span class="n">smthdPos</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.getAllSpikeWeights" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">getAllSpikeWeights</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">spike_clusters</span><span class="p">,</span> <span class="n">pos_times</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <h5 id="ephysiopy.common.binning.RateMap.getAllSpikeWeights--parameters">Parameters</h5>
<p>spike_times: np.ndarray
    spike times in seconds
spike_clusters: np.ndarray
    cluster identity vector
pos_times: np.ndarray
    the times at which position was captured in seconds</p>
<h5 id="ephysiopy.common.binning.RateMap.getAllSpikeWeights--returns">Returns</h5>
<p>np.ndarray
    the bincounts with respect to position for
    each cluster. Shape of returned array will
    be nClusters x npos</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getAllSpikeWeights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">spike_times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">spike_clusters</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="n">pos_times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spike_times: np.ndarray</span>
<span class="sd">        spike times in seconds</span>
<span class="sd">    spike_clusters: np.ndarray</span>
<span class="sd">        cluster identity vector</span>
<span class="sd">    pos_times: np.ndarray</span>
<span class="sd">        the times at which position was captured in seconds</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        the bincounts with respect to position for</span>
<span class="sd">        each cluster. Shape of returned array will</span>
<span class="sd">        be nClusters x npos</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_clusters</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spike_clusters</span><span class="p">)</span>
    <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">pos_times</span><span class="p">,</span> <span class="n">spike_times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="n">spike_clusters</span> <span class="o">==</span> <span class="n">c</span><span class="p">],</span> <span class="n">minlength</span><span class="o">=</span><span class="n">npos</span><span class="p">)</span>
               <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.getMap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">getMap</span><span class="p">(</span><span class="n">spkWeights</span><span class="p">,</span> <span class="n">varType</span><span class="o">=</span><span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span> <span class="n">mapType</span><span class="o">=</span><span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Bins up the variable type varType and returns a tuple of
(rmap, binnedPositionDir) or
(rmap, binnedPostionX, binnedPositionY)</p>
<h5 id="ephysiopy.common.binning.RateMap.getMap--parameters">Parameters</h5>
<p>spkWeights : array_like
    Shape equal to number of positions samples captured and consists of
    position weights. For example, if there were 5 positions
    recorded and a cell spiked once in position 2 and 5 times in
    position 3 and nothing anywhere else then pos_weights looks
    like: [0 0 1 5 0]
varType : Enum value - see Variable2Bin defined at top of this file
    The variable to bin up. Legal values are: XY, DIR and SPEED
mapType : enum value - see MapType defined at top of this file
    If RATE then the binned up spikes are divided by varType.
    Otherwise return binned up position. Options are RATE or POS
smoothing : bool, optional, default True
    Whether to smooth the data or not</p>
<h5 id="ephysiopy.common.binning.RateMap.getMap--returns">Returns</h5>
<p>binned_data, binned_pos : tuple
    This is either a 2-tuple or a 3-tuple depening on whether binned
    pos (mapType 'pos') or binned spikes (mapType 'rate') is asked
    for respectively</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span>
           <span class="n">varType</span><span class="o">=</span><span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="p">,</span>
           <span class="n">mapType</span><span class="o">=</span><span class="n">MapType</span><span class="o">.</span><span class="n">RATE</span><span class="p">,</span>
           <span class="n">smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
           <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bins up the variable type varType and returns a tuple of</span>
<span class="sd">    (rmap, binnedPositionDir) or</span>
<span class="sd">    (rmap, binnedPostionX, binnedPositionY)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spkWeights : array_like</span>
<span class="sd">        Shape equal to number of positions samples captured and consists of</span>
<span class="sd">        position weights. For example, if there were 5 positions</span>
<span class="sd">        recorded and a cell spiked once in position 2 and 5 times in</span>
<span class="sd">        position 3 and nothing anywhere else then pos_weights looks</span>
<span class="sd">        like: [0 0 1 5 0]</span>
<span class="sd">    varType : Enum value - see Variable2Bin defined at top of this file</span>
<span class="sd">        The variable to bin up. Legal values are: XY, DIR and SPEED</span>
<span class="sd">    mapType : enum value - see MapType defined at top of this file</span>
<span class="sd">        If RATE then the binned up spikes are divided by varType.</span>
<span class="sd">        Otherwise return binned up position. Options are RATE or POS</span>
<span class="sd">    smoothing : bool, optional, default True</span>
<span class="sd">        Whether to smooth the data or not</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    binned_data, binned_pos : tuple</span>
<span class="sd">        This is either a 2-tuple or a 3-tuple depening on whether binned</span>
<span class="sd">        pos (mapType &#39;pos&#39;) or binned spikes (mapType &#39;rate&#39;) is asked</span>
<span class="sd">        for respectively</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span>
        <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed</span>
        <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
        <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY_TIME</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_times</span><span class="p">)))</span>
        <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized variable to bin.&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">sample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">=</span> <span class="n">varType</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_spike_weights</span> <span class="o">=</span> <span class="n">spkWeights</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binsize</span><span class="p">)</span>

    <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span>
                                                 <span class="n">sample</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">,</span>
                                                 <span class="n">keep_these</span><span class="p">)</span>
    <span class="n">nanIdx</span> <span class="o">=</span> <span class="n">binned_pos</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">mapType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">MapType</span><span class="o">.</span><span class="n">POS</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>  <span class="c1"># return binned up position</span>
        <span class="k">if</span> <span class="n">smoothing</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">binned_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span>
                    <span class="n">binned_pos</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">binned_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                                       <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span>

    <span class="n">binned_spk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span> <span class="n">keep_these</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">MapType</span><span class="o">.</span><span class="n">SPK</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">binned_spk</span>
    <span class="c1"># binned_spk is returned as a tuple of the binned data and the bin</span>
    <span class="c1"># edges</span>
    <span class="k">if</span> <span class="s2">&quot;after&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">whenToSmooth</span><span class="p">:</span>
        <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
        <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">rmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">rmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rmap</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">rmap</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                             <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># default case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">smoothing</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span><span class="p">,</span> <span class="n">binned_pos_edges</span>
        <span class="k">if</span> <span class="n">varType</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">DIR</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">binned_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
            <span class="n">binned_spk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_circPadSmooth</span><span class="p">(</span><span class="n">binned_spk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">)</span>
            <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binned_pos</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">binned_pos</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                                   <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">binned_spk_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">binned_spk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">binned_spk_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">binned_spk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">binned_spk</span> <span class="o">=</span> <span class="n">binned_spk_tmp</span>
            <span class="n">binned_spk</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span>
                <span class="n">binned_spk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smooth_sz</span><span class="p">,</span>
                <span class="n">ftype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">smoothingType</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">rmap</span> <span class="o">=</span> <span class="n">binned_spk</span> <span class="o">/</span> <span class="n">binned_pos</span>
            <span class="k">if</span> <span class="n">rmap</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">rmap</span><span class="p">[</span><span class="n">nanIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">rmap</span><span class="p">,</span> <span class="n">binned_pos_edges</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.getSAC" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">getSAC</span><span class="p">(</span><span class="n">spkWeights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Returns the SAC - convenience function</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getSAC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spkWeights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the SAC - convenience function</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getMap</span><span class="p">(</span><span class="n">spkWeights</span><span class="o">=</span><span class="n">spkWeights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">nodwell</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">rmap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoCorr2D</span><span class="p">(</span><span class="n">rmap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodwell</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.getSpatialSparsity" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">getSpatialSparsity</span><span class="p">(</span><span class="n">spkWeights</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Gets the spatial sparsity measure - closer to 1 means
sparser firing field.</p>
<h5 id="ephysiopy.common.binning.RateMap.getSpatialSparsity--references">References</h5>
<p>Skaggs, W.E., McNaughton, B.L., Wilson, M.A. &amp; Barnes, C.A.
Theta phase precession in hippocampal neuronal populations
and the compression of temporal sequences.
Hippocampus 6, 149172 (1996).</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">getSpatialSparsity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">spkWeights</span><span class="p">,</span>
                       <span class="n">sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Gets the spatial sparsity measure - closer to 1 means</span>
<span class="sd">    sparser firing field.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Skaggs, W.E., McNaughton, B.L., Wilson, M.A. &amp; Barnes, C.A.</span>
<span class="sd">    Theta phase precession in hippocampal neuronal populations</span>
<span class="sd">    and the compression of temporal sequences.</span>
<span class="sd">    Hippocampus 6, 149172 (1996).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var2Bin</span> <span class="o">=</span> <span class="n">VariableToBin</span><span class="o">.</span><span class="n">XY</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_calcBinEdges</span><span class="p">()</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy</span>
    <span class="n">keep_these</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">,</span>
                           <span class="n">keep_these</span><span class="p">)</span>
    <span class="n">npos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">)</span>
    <span class="n">p_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">npos</span> <span class="o">/</span> <span class="n">sample_rate</span>
    <span class="n">spk</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binData</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_binedges</span><span class="p">,</span>
                           <span class="n">spkWeights</span><span class="p">,</span>
                           <span class="n">keep_these</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_i</span><span class="o">*</span><span class="n">spk</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">p_i</span><span class="o">*</span><span class="n">spk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.get_egocentric_boundary_map" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_egocentric_boundary_map</span><span class="p">(</span><span class="n">spk_weights</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">xy_binsize</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">arena_type</span><span class="o">=</span><span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="n">return_dists</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_raw_spk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_raw_occ</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Supposed to help construct dwell time/spike counts
maps wrt boundaries at given egocentric directions
and distances
NB: for the directional input
the 0 degree reference is horiztonal pointing
East and moves counter-clockwise</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_egocentric_boundary_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">spk_weights</span><span class="p">,</span>
                                <span class="n">degs_per_bin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="n">xy_binsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">,</span>
                                <span class="n">arena_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;circle&quot;</span><span class="p">,</span>
                                <span class="n">return_dists</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">return_raw_spk</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="n">return_raw_occ</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">namedtuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Supposed to help construct dwell time/spike counts</span>
<span class="sd">    maps wrt boundaries at given egocentric directions</span>
<span class="sd">    and distances</span>
<span class="sd">    NB: for the directional input</span>
<span class="sd">    the 0 degree reference is horiztonal pointing</span>
<span class="sd">    East and moves counter-clockwise</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;No direction data available&quot;</span>
    <span class="c1"># initially do some binning to get valid locations</span>
    <span class="c1"># (some might be nans due to</span>
    <span class="c1"># arena shape and/or poor sampling) and then digitize</span>
    <span class="c1"># the x and y positions</span>
    <span class="c1"># and the angular positions</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">binsize</span> <span class="o">=</span> <span class="n">xy_binsize</span>  <span class="c1"># this will trigger a</span>
    <span class="c1"># re-calculation of the bin edges</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="p">)</span>

    <span class="c1"># Use the shaeply package to specify some geometry for the arena</span>
    <span class="c1"># boundary and the lines radiating out</span>
    <span class="c1"># from the current location of the animal. The geometry for the </span>
    <span class="c1"># arena should be user specified but for now I&#39;ll just use a circle</span>
    <span class="k">if</span> <span class="n">arena_type</span> <span class="o">==</span> <span class="s2">&quot;circle&quot;</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">circle_centre</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">arena_boundary</span> <span class="o">=</span> <span class="n">circle_centre</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span><span class="o">.</span><span class="n">boundary</span>
    <span class="c1"># now we have a circle with its centre at the centre of the arena</span>
    <span class="c1"># i.e. the circle defines the arena edges. Calling .boundary on the</span>
    <span class="c1"># circle geometry actually gives us a 65-gon polygon</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_boundary_distance_lookup</span><span class="p">(</span>
        <span class="n">arena_boundary</span><span class="p">,</span> <span class="n">degs_per_bin</span><span class="p">,</span> <span class="n">xy_binsize</span><span class="p">)</span>
    <span class="c1"># iterate through the digitized locations (x/y and angular), using the</span>
    <span class="c1"># lookup table to get the distances to the arena boundary and then</span>
    <span class="c1"># increment the appropriate bin in the egocentric boundary map</span>
    <span class="n">good_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xy_by_heading</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">good_idx</span><span class="p">]],</span>
                                      <span class="n">bins</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                      <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_weights</span><span class="p">[</span><span class="n">good_idx</span><span class="p">])</span>
    <span class="n">spk_xy_by_hd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">good_idx</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">dir</span><span class="p">[</span><span class="n">good_idx</span><span class="p">]],</span>
                                     <span class="n">bins</span><span class="o">=</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                                     <span class="n">weights</span><span class="o">=</span><span class="n">spk_weights</span><span class="p">[</span><span class="n">good_idx</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">xy_by_heading</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">distances</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">distlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anglist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spkdists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spkangs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i_bin</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">distances</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">i_dist</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">i_bin</span><span class="p">]</span>
        <span class="n">valid_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">i_dist</span><span class="p">)</span>
        <span class="n">nonzero_bincounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">xy_by_heading</span><span class="p">[</span><span class="n">i_bin</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nonzero_spkbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">spk_xy_by_hd</span><span class="p">[</span><span class="n">i_bin</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_angle</span> <span class="ow">in</span> <span class="n">nonzero_bincounts</span><span class="p">:</span>
            <span class="n">ego_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">i_angle</span><span class="p">)[</span><span class="n">valid_dist</span><span class="p">]</span>
            <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">xy_by_heading</span><span class="p">[</span><span class="n">i_bin</span><span class="p">][</span><span class="n">i_angle</span><span class="p">]</span>
            <span class="n">ego_angles_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ego_angles</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
            <span class="n">dist_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i_dist</span><span class="p">[</span><span class="n">valid_dist</span><span class="p">],</span> <span class="n">n_repeats</span><span class="p">)</span>
            <span class="n">distlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_repeats</span><span class="p">)</span>
            <span class="n">anglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ego_angles_repeats</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i_angle</span> <span class="ow">in</span> <span class="n">nonzero_spkbins</span><span class="p">:</span>
                <span class="n">n_repeats</span> <span class="o">=</span> <span class="n">spk_xy_by_hd</span><span class="p">[</span><span class="n">i_bin</span><span class="p">][</span><span class="n">i_angle</span><span class="p">]</span>
                <span class="n">ego_angles_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ego_angles</span><span class="p">,</span> <span class="n">n_repeats</span><span class="p">)</span>
                <span class="n">dist_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i_dist</span><span class="p">[</span><span class="n">valid_dist</span><span class="p">],</span> <span class="n">n_repeats</span><span class="p">)</span>
                <span class="n">spkdists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dist_repeats</span><span class="p">)</span>
                <span class="n">spkangs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ego_angles_repeats</span><span class="p">)</span>
    <span class="n">flat_angs</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">anglist</span><span class="p">)</span>
    <span class="n">flat_dists</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">distlist</span><span class="p">)</span>
    <span class="n">flat_spk_dists</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">spkdists</span><span class="p">)</span>
    <span class="n">flat_spk_angs</span> <span class="o">=</span> <span class="n">flatten_list</span><span class="p">(</span><span class="n">spkangs</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">radius</span><span class="o">/</span><span class="n">xy_binsize</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">angles</span><span class="p">)]</span>
    <span class="n">ego_boundary_occ</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flat_dists</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">flat_angs</span><span class="p">,</span>
                                            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">ego_boundary_spk</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flat_spk_dists</span><span class="p">,</span>
                                            <span class="n">y</span><span class="o">=</span><span class="n">flat_spk_angs</span><span class="p">,</span>
                                            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">kernel</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">x_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">y_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sm_occ</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">ego_boundary_occ</span><span class="p">,</span>
                                  <span class="n">kernel</span><span class="p">,</span>
                                  <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
    <span class="n">sm_spk</span> <span class="o">=</span> <span class="n">convolution</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">ego_boundary_spk</span><span class="p">,</span>
                                  <span class="n">kernel</span><span class="p">,</span>
                                  <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;extend&#39;</span><span class="p">)</span>
    <span class="n">ego_boundary_map</span> <span class="o">=</span> <span class="n">sm_spk</span> <span class="o">/</span> <span class="n">sm_occ</span>
    <span class="n">EgoMap</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;EgoMap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;rmap&#39;</span><span class="p">,</span> <span class="s1">&#39;occ&#39;</span><span class="p">,</span> <span class="s1">&#39;spk&#39;</span><span class="p">,</span> <span class="s1">&#39;dists&#39;</span><span class="p">],</span>
                        <span class="n">defaults</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">em</span> <span class="o">=</span> <span class="n">EgoMap</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">rmap</span><span class="o">=</span><span class="n">ego_boundary_map</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_dists</span><span class="p">:</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">dists</span><span class="o">=</span><span class="n">distances</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_raw_occ</span><span class="p">:</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">occ</span><span class="o">=</span><span class="n">ego_boundary_occ</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_raw_spk</span><span class="p">:</span>
        <span class="n">em</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">spk</span><span class="o">=</span><span class="n">ego_boundary_spk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">em</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="ephysiopy.common.binning.RateMap.tWinSAC" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">tWinSAC</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">spkIdx</span><span class="p">,</span> <span class="n">ppm</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span> <span class="n">winSize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">pos_sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span> <span class="n">boxcar</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Pthresh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">downsampfreq</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Temporal windowed spatial autocorrelation.</p>
<h5 id="ephysiopy.common.binning.RateMap.tWinSAC--parameters">Parameters</h5>
<p>xy : array_like
    The position data
spkIdx : array_like
    The indices in xy where the cell fired
ppm : int, optional
    The camera pixels per metre. Default 365
winSize : int, optional
    The window size for the temporal search
pos_sample_rate : int, optional
    The rate at which position was sampled. Default 50
nbins : int, optional
    The number of bins for creating the resulting ratemap. Default 71
boxcar : int, optional
    The size of the smoothing kernel to smooth ratemaps. Default 5
Pthresh : int, optional
    The cut=off for values in the ratemap; values &lt; Pthresh become
    nans.
    Default 100
downsampfreq : int, optional
    How much to downsample. Default 50
plot : bool, optional
    Whether to show a plot of the result. Default False</p>
<h5 id="ephysiopy.common.binning.RateMap.tWinSAC--returns">Returns</h5>
<p>H : array_like
    The temporal windowed SAC</p>

          <details class="quote">
            <summary>Source code in <code>ephysiopy/common/binning.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">tWinSAC</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">xy</span><span class="p">,</span>
    <span class="n">spkIdx</span><span class="p">,</span>
    <span class="n">ppm</span><span class="o">=</span><span class="mi">365</span><span class="p">,</span>
    <span class="n">winSize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">pos_sample_rate</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">nbins</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span>
    <span class="n">boxcar</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">Pthresh</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">downsampfreq</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Temporal windowed spatial autocorrelation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    xy : array_like</span>
<span class="sd">        The position data</span>
<span class="sd">    spkIdx : array_like</span>
<span class="sd">        The indices in xy where the cell fired</span>
<span class="sd">    ppm : int, optional</span>
<span class="sd">        The camera pixels per metre. Default 365</span>
<span class="sd">    winSize : int, optional</span>
<span class="sd">        The window size for the temporal search</span>
<span class="sd">    pos_sample_rate : int, optional</span>
<span class="sd">        The rate at which position was sampled. Default 50</span>
<span class="sd">    nbins : int, optional</span>
<span class="sd">        The number of bins for creating the resulting ratemap. Default 71</span>
<span class="sd">    boxcar : int, optional</span>
<span class="sd">        The size of the smoothing kernel to smooth ratemaps. Default 5</span>
<span class="sd">    Pthresh : int, optional</span>
<span class="sd">        The cut=off for values in the ratemap; values &lt; Pthresh become</span>
<span class="sd">        nans.</span>
<span class="sd">        Default 100</span>
<span class="sd">    downsampfreq : int, optional</span>
<span class="sd">        How much to downsample. Default 50</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        Whether to show a plot of the result. Default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    H : array_like</span>
<span class="sd">        The temporal windowed SAC</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># [Stage 0] Get some numbers</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">/</span> <span class="n">ppm</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">n_samps</span> <span class="o">=</span> <span class="n">xy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n_spks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">)</span>
    <span class="n">winSizeBins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">winSize</span> <span class="o">*</span> <span class="n">pos_sample_rate</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">])</span>
    <span class="c1"># factor by which positions are downsampled</span>
    <span class="n">downsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">pos_sample_rate</span> <span class="o">/</span> <span class="n">downsampfreq</span><span class="p">)</span>
    <span class="n">Pthresh</span> <span class="o">=</span> <span class="n">Pthresh</span> <span class="o">/</span> <span class="n">downsample</span>  <span class="c1"># take account of downsampling</span>

    <span class="c1"># [Stage 1] Calculate number of spikes in the window for each spikeInd</span>
    <span class="c1"># (ignoring spike itself)</span>
    <span class="c1"># 1a. Loop preparation</span>
    <span class="n">nSpikesInWin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_spks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># 1b. Keep looping until we have dealt with all spikes</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">))</span>
        <span class="n">nSpikesInWin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># ignore ith spike</span>

    <span class="c1"># [Stage 2] Prepare for main loop</span>
    <span class="c1"># 2a. Work out offset inidices to be used when storing spike data</span>
    <span class="n">off_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="n">nSpikesInWin</span><span class="p">])</span>
    <span class="n">off_spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">off_spike</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 2b. Work out number of downsampled pos bins in window and</span>
    <span class="c1"># offset indices for storing data</span>
    <span class="n">nPosInWindow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">winSizeBins</span><span class="p">,</span> <span class="n">n_samps</span> <span class="o">-</span> <span class="n">spkIdx</span><span class="p">)</span>
    <span class="n">nDownsampInWin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">nPosInWindow</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">downsample</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">off_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">nDownsampInWin</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">off_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">off_dwell</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># 2c. Pre-allocate dwell and spike arrays, singles for speed</span>
    <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">off_dwell</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">off_spike</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">filled_pvals</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">filled_svals</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_spks</span><span class="p">):</span>
        <span class="c1"># calculate dwell displacements</span>
        <span class="n">winInd_dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">,</span> <span class="n">n_samps</span><span class="p">),</span>
            <span class="n">downsample</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winInd_dwell</span><span class="p">)</span>
        <span class="n">dwell</span><span class="p">[:,</span> <span class="n">filled_pvals</span><span class="p">:</span> <span class="n">filled_pvals</span> <span class="o">+</span> <span class="n">WL</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="n">winInd_dwell</span><span class="p">])</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="p">)</span>
        <span class="n">filled_pvals</span> <span class="o">=</span> <span class="n">filled_pvals</span> <span class="o">+</span> <span class="n">WL</span>
        <span class="c1"># calculate spike displacements</span>
        <span class="n">winInd_spks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">i</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span> <span class="n">n_spks</span><span class="p">]</span> <span class="o">&lt;</span>
                           <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">winSizeBins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">WL</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">winInd_spks</span><span class="p">)</span>
        <span class="n">spike</span><span class="p">[:,</span> <span class="n">filled_svals</span><span class="p">:</span> <span class="n">filled_svals</span> <span class="o">+</span> <span class="n">WL</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">winInd_spks</span><span class="p">]])</span> <span class="o">-</span> <span class="n">xy</span><span class="p">[:,</span> <span class="n">spkIdx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="p">)</span>
        <span class="n">filled_svals</span> <span class="o">=</span> <span class="n">filled_svals</span> <span class="o">+</span> <span class="n">WL</span>

    <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dwell</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">spike</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">spike</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">dwell</span><span class="p">,</span> <span class="o">-</span><span class="n">dwell</span><span class="p">))</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">spike</span><span class="p">,</span> <span class="o">-</span><span class="n">spike</span><span class="p">))</span>

    <span class="n">dwell_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dwell_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">binsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwell_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dwell_min</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">nbins</span>

    <span class="n">dwell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="p">(</span><span class="n">dwell</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">dwell</span><span class="p">)</span> <span class="o">*</span> <span class="n">dwell_min</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">binsize</span>
    <span class="p">)</span>
    <span class="n">spike</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
        <span class="p">(</span><span class="n">spike</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">spike</span><span class="p">)</span> <span class="o">*</span> <span class="n">dwell_min</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">/</span> <span class="n">binsize</span>
    <span class="p">)</span>

    <span class="n">binsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dwell</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">binedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">binsize</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">Hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">dwell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">dwell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="nb">range</span><span class="o">=</span><span class="n">binedges</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binsize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Hs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">spike</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">spike</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                        <span class="nb">range</span><span class="o">=</span><span class="n">binedges</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">binsize</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># reverse y,x order</span>
    <span class="n">Hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">Hs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">fHp</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">Hp</span><span class="p">,</span> <span class="n">boxcar</span><span class="p">)</span>
    <span class="n">fHs</span> <span class="o">=</span> <span class="n">blurImage</span><span class="p">(</span><span class="n">Hs</span><span class="p">,</span> <span class="n">boxcar</span><span class="p">)</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">fHs</span> <span class="o">/</span> <span class="n">fHp</span>
    <span class="n">H</span><span class="p">[</span><span class="n">Hp</span> <span class="o">&lt;</span> <span class="n">Pthresh</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">return</span> <span class="n">H</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>